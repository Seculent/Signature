// === –ù–ê–°–¢–†–û–ô–ö–ò ===
const CONFIG = {
  emailTo: 'akhmadeev93@gmail.com',
  salonName: '–°–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã',
  logoUrl: 'https://–≤–∞—à-—Å–∞–π—Ç/logo.png',
  spreadsheetId: '1K00wcw4QC0jrKA4Urqi1qiWqyTkHHGsNy5FtRbqsbPg' // –í–∞—à ID —Ç–∞–±–ª–∏—Ü—ã
};

// === –û–ë–†–ê–ë–û–¢–ö–ê POST –ó–ê–ü–†–û–°–û–í ===
function doPost(e) {
  console.log('üì® POST –∑–∞–ø—Ä–æ—Å –ø–æ–ª—É—á–µ–Ω');
  
  try {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ POST
    let formData;
    if (e.postData && e.postData.contents) {
      formData = JSON.parse(e.postData.contents);
    } else {
      throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–ø—Ä–æ—Å–µ');
    }
    
    console.log('üìù –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è:', formData.name);
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    const result = processFormDataAsync(formData);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: '–§–æ—Ä–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≤ doPost:', error);
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.message
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
function doGet(e) {
  console.log('üì® GET –∑–∞–ø—Ä–æ—Å –æ—Ç iframe');
  console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', JSON.stringify(e?.parameters || {}, null, 2));
  
  // –ï—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
  if (e?.parameters?.name || e?.parameters?.data) {
    try {
      let formData;
      
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
      if (e.parameters.data) {
        formData = JSON.parse(e.parameters.data[0]);
      } else {
        formData = {
          name: e.parameters.name ? e.parameters.name[0] : '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          email: e.parameters.email ? e.parameters.email[0] : '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          phone: e.parameters.phone ? e.parameters.phone[0] : '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          procedure: e.parameters.procedure ? e.parameters.procedure[0] : '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
          consent: e.parameters.consent ? e.parameters.consent[0] === 'true' : false,
          signature: e.parameters.signature ? e.parameters.signature[0] : '',
          timestamp: new Date().toISOString()
        };
      }
      
      console.log('üìù –î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:', formData.name, formData.email);
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å iframe)
      processFormDataAsync(formData);
      
      // –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –¥–ª—è iframe
      return HtmlService.createHtmlOutput(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>
            body {
              font-family: Arial, sans-serif;
              background: #f5f5f5;
              margin: 0;
              padding: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              min-height: 100vh;
            }
            .success-message {
              background: white;
              padding: 40px;
              border-radius: 15px;
              box-shadow: 0 5px 20px rgba(0,0,0,0.1);
              text-align: center;
              max-width: 500px;
            }
            .success-icon {
              font-size: 60px;
              color: #4CAF50;
              margin-bottom: 20px;
            }
            h2 {
              color: #333;
              margin-bottom: 15px;
            }
            p {
              color: #666;
              line-height: 1.6;
              margin-bottom: 10px;
            }
            .close-btn {
              background: #4CAF50;
              color: white;
              border: none;
              padding: 12px 30px;
              border-radius: 25px;
              font-size: 16px;
              cursor: pointer;
              margin-top: 20px;
              transition: background 0.3s;
            }
            .close-btn:hover {
              background: #45a049;
            }
          </style>
        </head>
        <body>
          <div class="success-message">
            <div class="success-icon">‚úÖ</div>
            <h2>–§–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</h2>
            <p>–°–ø–∞—Å–∏–±–æ, ${formData.name}!</p>
            <p>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.</p>
            <p>üìß –ù–∞ –≤–∞—à—É –ø–æ—á—Ç—É –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</p>
            <p>üìÑ PDF –¥–æ–∫—É–º–µ–Ω—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü—É —Å–∞–ª–æ–Ω–∞.</p>
            <button class="close-btn" onclick="sendSuccessMessage()">–ó–∞–∫—Ä—ã—Ç—å</button>
            
            <script>
              function sendSuccessMessage() {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º—É –æ–∫–Ω—É
                window.parent.postMessage('formSuccess', '*');
              }
              
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
              setTimeout(sendSuccessMessage, 3000);
            </script>
          </div>
        </body>
        </html>
      `);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:', error);
      
      return HtmlService.createHtmlOutput(`
        <!DOCTYPE html>
        <html>
        <body style="font-family: Arial; padding: 20px; background: #f8d7da; color: #721c24;">
          <h2>‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
          <p>${error.message}</p>
          <button onclick="window.parent.postMessage('formError', '*')">–ó–∞–∫—Ä—ã—Ç—å</button>
          <script>
            setTimeout(() => window.parent.postMessage('formError', '*'), 2000);
          </script>
        </body>
        </html>
      `);
    }
  }
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ —Å—Ç—Ä–∞–Ω–∏—Ü—É
  return HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
    <body style="font-family: Arial; padding: 20px;">
      <h2>‚úÖ –°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</h2>
      <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ iframe –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>
      <p>–ü—Ä–∏–º–µ—Ä URL: ${ScriptApp.getService().getUrl()}?name=–¢–µ—Å—Ç&email=test@example.com</p>
    </body>
    </html>
  `);
}

// === –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –î–ê–ù–ù–´–• ===
function processFormDataAsync(formData) {
  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ñ–æ–Ω–µ
  try {
    // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
    saveToSheet(formData);
    
    // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –Ω–∞ email
    sendPdfEmail(formData);
    
    // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
    sendClientConfirmation(formData);
    
    console.log('‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–ª—è:', formData.name);
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
    MailApp.sendEmail({
      to: CONFIG.emailTo,
      subject: '‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã',
      body: `–û—à–∏–±–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ ${formData.name}: ${error.message}\n\n${error.stack}`
    });
  }
}

// === –°–û–•–†–ê–ù–ï–ù–ò–ï –í –¢–ê–ë–õ–ò–¶–£ ===
function saveToSheet(data) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.spreadsheetId);
    const sheet = ss.getSheetByName('–ó–∞—è–≤–∫–∏') || ss.insertSheet('–ó–∞—è–≤–∫–∏');
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(['–î–∞—Ç–∞', '–ò–º—è', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ü—Ä–æ—Ü–µ–¥—É—Ä–∞', '–°–æ–≥–ª–∞—Å–∏–µ', '–ü–æ–¥–ø–∏—Å—å', '–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏']);
    }
    
    // –î–∞–Ω–Ω—ã–µ
    sheet.appendRow([
      new Date(),
      data.name || '',
      data.email || '',
      data.phone || '',
      data.procedure || '',
      data.consent ? '–î–ê' : '–ù–ï–¢',
      data.signature ? '–ï—Å—Ç—å' : '–ù–µ—Ç',
      new Date().toISOString()
    ]);
    
    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É:', data.name);
    return true;
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    return false;
  }
}

function createPdfWithSignatureBlob(htmlContent, data) {
  try {
    // –°–æ–∑–¥–∞–µ–º HTML –±–ª–æ–±
    const htmlBlob = Utilities.newBlob(htmlContent, 'text/html', 'temp.html');
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å—å, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ—ë
    if (data.signature && data.signature.startsWith('data:image')) {
      try {
        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ –±–ª–æ–±
        const signatureData = data.signature.split(',')[1];
        const signatureBlob = Utilities.newBlob(
          Utilities.base64Decode(signatureData),
          'image/png',
          'signature.png'
        );
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const signatureUrl = DriveApp.createFile(signatureBlob).getDownloadUrl();
        
        // –ó–∞–º–µ–Ω—è–µ–º base64 –Ω–∞ URL –≤ HTML
        htmlContent = htmlContent.replace(
          data.signature, 
          signatureUrl
        );
      } catch (imgError) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥–ø–∏—Å—å:', imgError);
      }
    }
    
    const pdfBlob = htmlBlob.getAs('application/pdf');
    const date = new Date().toISOString().split('T')[0];
    const safeName = (data.name || '–ö–ª–∏–µ–Ω—Ç').replace(/[^a-zA-Z–ê-–Ø–∞-—è0-9\s]/g, '').replace(/\s+/g, '_');
    const filename = `–°–æ–≥–ª–∞—à–µ–Ω–∏–µ_${safeName}_${date}.pdf`;
    
    pdfBlob.setName(filename);
    return pdfBlob;
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF:', error);
    throw error;
  }
}

// === –û–¢–ü–†–ê–í–ö–ê PDF ===
function sendPdfEmail(data) {
  try {
    console.log('üìß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF –¥–ª—è:', data.name);
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    const htmlContent = generatePdfHtml(data);
    const pdfBlob = createPdfBlob(htmlContent, data.name);
    
    // Email —Ç–µ–∫—Å—Ç
    const emailBody = `
–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –∏–∑ —Ñ–æ—Ä–º—ã:

üë§ –ö–ª–∏–µ–Ω—Ç: ${data.name}
üìß Email: ${data.email}
üìû –¢–µ–ª–µ—Ñ–æ–Ω: ${data.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üíÜ –ü—Ä–æ—Ü–µ–¥—É—Ä–∞: ${data.procedure || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
‚úÖ –°–æ–≥–ª–∞—Å–∏–µ: ${data.consent ? '–ø–æ–ª—É—á–µ–Ω–æ' : '–Ω–µ—Ç'}
üìù –ü–æ–¥–ø–∏—Å—å: ${data.signature ? '–ø—Ä–∏–ª–æ–∂–µ–Ω–∞' : '–Ω–µ—Ç'}

PDF –¥–æ–∫—É–º–µ–Ω—Ç —Å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω –∫ –ø–∏—Å—å–º—É.
    `.trim();
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
    GmailApp.sendEmail(
      CONFIG.emailTo,
      `‚úÖ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ: ${data.name} - ${new Date().toLocaleDateString('ru-RU')}`,
      emailBody,
      {
        attachments: [pdfBlob],
        name: CONFIG.salonName
      }
    );
    
    console.log('‚úÖ PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email');
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF:', error);
    throw error;
  }
}

function logToSheet(message) {
  const ss = SpreadsheetApp.openById(CONFIG.spreadsheetId);
  const logSheet = ss.getSheetByName('–õ–æ–≥–∏') || ss.insertSheet('–õ–æ–≥–∏');
  logSheet.appendRow([new Date(), message]);
}

// === –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ö–õ–ò–ï–ù–¢–£ ===
function sendClientConfirmation(data) {
  try {
    const body = `
–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) ${data.name},

–ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –≤–∞—Å –∑–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤ –Ω–∞—à–µ–º —Å–∞–ª–æ–Ω–µ.

–í–∞—à–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ ${new Date().toLocaleDateString('ru-RU')}.

–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
${CONFIG.salonName}
    `.trim();
    
    MailApp.sendEmail({
      to: data.email,
      subject: `${CONFIG.salonName} - –í–∞—à–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ`,
      body: body
    });
    
    console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É');
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:', error);
  }
}

// === –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML –î–õ–Ø PDF (–≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥) ===
function generatePdfHtml(data) {
  const today = new Date();
  const dateStr = today.toLocaleDateString('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    .header { text-align: center; margin-bottom: 40px; }
    .salon-name { color: #e91e63; font-size: 28px; }
    .client-info { background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .signature-box { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="salon-name">${CONFIG.salonName}</h1>
    <p>–°–æ–≥–ª–∞—à–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞</p>
    <p>‚Ññ ${Math.floor(Math.random() * 10000)}/${today.getFullYear()} –æ—Ç ${dateStr}</p>
  </div>
  
  <div class="client-info">
    <h3>–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:</h3>
    <p><strong>–§–ò–û:</strong> ${data.name}</p>
    <p><strong>Email:</strong> ${data.email}</p>
    ${data.phone ? `<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.phone}</p>` : ''}
    ${data.procedure ? `<p><strong>–ü—Ä–æ—Ü–µ–¥—É—Ä–∞:</strong> ${data.procedure}</p>` : ''}
  </div>
  
  <div>
    <h3>–°–æ–≥–ª–∞—à–µ–Ω–∏–µ:</h3>
    <p>–Ø, ${data.name}, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ —Å–æ –≤—Å–µ–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã.</p>
  </div>
  
  <div class="signature-box">
    <p><strong>–ü–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞:</strong></p>
    ${data.signature ? `<img src="${data.signature}" style="max-width: 300px; border: 1px solid #ddd;">` : '<p>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å—å</p>'}
    <p>${data.name}</p>
    <p>${dateStr}</p>
  </div>
</body>
</html>
  `;
}

// === –°–û–ó–î–ê–ù–ò–ï PDF ===
function createPdfBlob(htmlContent, clientName) {
  try {
    const htmlBlob = Utilities.newBlob(htmlContent, 'text/html', 'temp.html');
    const pdfBlob = htmlBlob.getAs('application/pdf');
    
    const date = new Date().toISOString().split('T')[0];
    const safeName = (clientName || '–ö–ª–∏–µ–Ω—Ç').replace(/[^a-zA-Z–ê-–Ø–∞-—è\s]/g, '').replace(/\s+/g, '_');
    const filename = `–°–æ–≥–ª–∞—à–µ–Ω–∏–µ_${safeName}_${date}.pdf`;
    
    pdfBlob.setName(filename);
    console.log('‚úÖ PDF —Å–æ–∑–¥–∞–Ω:', filename);
    
    return pdfBlob;
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PDF:', error);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞
    const textContent = `–°–û–ì–õ–ê–®–ï–ù–ò–ï\n\n${clientName}\n\n${new Date().toLocaleString()}`;
    return Utilities.newBlob(textContent, 'text/plain', '–°–æ–≥–ª–∞—à–µ–Ω–∏–µ.txt');
  }
}

// === –¢–ï–°–¢–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
function testIframeMethod() {
  const testData = {
    name: "–¢–µ—Å—Ç–æ–≤—ã–π –ö–ª–∏–µ–Ω—Ç",
    email: CONFIG.emailTo,
    phone: "+7 (999) 123-45-67",
    procedure: "–ú–∞—Å—Å–∞–∂",
    consent: true,
    signature: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
  };
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π URL
  const params = Object.keys(testData)
    .map(key => `${key}=${encodeURIComponent(testData[key])}`)
    .join('&');
  
  const url = `${ScriptApp.getService().getUrl()}?${params}`;
  console.log('üîó –¢–µ—Å—Ç–æ–≤—ã–π URL:', url);
  console.log('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏');
}